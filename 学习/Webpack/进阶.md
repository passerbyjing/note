### 1. ä¼˜åŒ–æ„å»ºé€Ÿåº¦

#### 1.1 æ„å»ºè´¹æ—¶åˆ†æ

è¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ’ä»¶ [speed-measure-webpack-plugin](https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fspeed-measure-webpack-plugin)ï¼Œæˆ‘ä»¬å‚è€ƒæ–‡æ¡£é…ç½®ä¸€ä¸‹

1. é¦–å…ˆå®‰è£…ä¸€ä¸‹

```bash
$ npm i -D speed-measure-webpack-plugin
```

1. ä¿®æ”¹æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ webpack.config.js

```js
...
// è´¹æ—¶åˆ†æ
const SpeedMeasurePlugin = require("speed-measure-webpack-plugin");
const smp = new SpeedMeasurePlugin();
...

const config = {...}

module.exports = (env, argv) => {
  // è¿™é‡Œå¯ä»¥é€šè¿‡ä¸åŒçš„æ¨¡å¼ä¿®æ”¹ config é…ç½®


  return smp.wrap(config);
}
```

1. æ‰§è¡Œæ‰“åŒ…

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ae510d710d494d22a00378d8d52753d2~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

æŠ¥é”™äº†ğŸ¤¦ğŸ»â€â™‚ï¸

è¿™é‡Œå°±æš´éœ²äº†ä½¿ç”¨è¿™ä¸ªæ’ä»¶çš„ä¸€ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯ï¼š

- **æœ‰äº› Loader æˆ–è€… Plugin æ–°ç‰ˆæœ¬ä¼šä¸å…¼å®¹ï¼Œéœ€è¦è¿›è¡Œé™çº§å¤„ç†**

è¿™é‡Œæˆ‘ä»¬å¯¹ `mini-css-extract-plugin` è¿›è¡Œä¸€ä¸‹é™çº§å¤„ç†: `^2.1.0` -> `^1.3.6`

é‡æ–°å®‰è£…ä¸€ä¸‹ä¾èµ–ï¼Œå†æ¬¡æ‰§è¡Œæ‰“åŒ…

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e369fd6b2994270971fd87291e694f6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

é™äº†ç‰ˆæœ¬ä¹‹åï¼Œè¿˜æ˜¯æŠ¥é”™ï¼Œæ ¹æ®æç¤ºä¿¡æ¯ï¼Œæˆ‘ä»¬ç»™é…ç½®åŠ ä¸Š `publicPath: './'`

```js
output: {
    filename: 'bundle.js', // è¾“å‡ºæ–‡ä»¶å
    path: path.join(__dirname, 'dist'), // è¾“å‡ºæ–‡ä»¶ç›®å½•
    publicPath: './'
  },
```

åœ¨å°è¯•ä¸€æ¬¡

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8abe8e0dfeb94ffe94adce229d04d0e3~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

æˆåŠŸäº†ï¼

> **æ³¨æ„ï¼šåœ¨ webpack5.x ä¸­ä¸ºäº†ä½¿ç”¨è´¹æ—¶åˆ†æå»å¯¹æ’ä»¶è¿›è¡Œé™çº§æˆ–è€…ä¿®æ”¹é…ç½®å†™æ³•æ˜¯éå¸¸ä¸åˆ’ç®—çš„**ï¼Œè¿™é‡Œå› ä¸ºæ¼”ç¤ºéœ€è¦ï¼Œæˆ‘åé¢ä¼šç»§ç»­ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œå»ºè®®è¿˜æ˜¯ä¸è¦ä½¿ç”¨ã€‚

#### 1.2 ä¼˜åŒ– resolve é…ç½®

##### 1.2.1 alias

alias ç”¨çš„åˆ›å»º `import` æˆ– `require` çš„åˆ«åï¼Œç”¨æ¥ç®€åŒ–æ¨¡å—å¼•ç”¨ï¼Œé¡¹ç›®ä¸­åŸºæœ¬éƒ½éœ€è¦è¿›è¡Œé…ç½®ã€‚

```js
const path = require('path')
...
// è·¯å¾„å¤„ç†æ–¹æ³•
function resolve(dir){
  return path.join(__dirname, dir);
}

 const config  = {
  ...
  resolve:{
    // é…ç½®åˆ«å
    alias: {
      '~': resolve('src'),
      '@': resolve('src'),
      'components': resolve('src/components'),
    }
  }
};
```

é…ç½®å®Œæˆä¹‹åï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å°±å¯ä»¥

```js
// ä½¿ç”¨ src åˆ«å ~ 
import '~/fonts/iconfont.css'

// ä½¿ç”¨ src åˆ«å @ 
import '@/fonts/iconfont.css'

// ä½¿ç”¨ components åˆ«å
import footer from "components/footer";
```

##### 1.2.2 extensions

webpack é»˜è®¤é…ç½®

```js
const config = {
  //...
  resolve: {
    extensions: ['.js', '.json', '.wasm'],
  },
};
```

å¦‚æœç”¨æˆ·å¼•å…¥æ¨¡å—æ—¶ä¸å¸¦æ‰©å±•åï¼Œä¾‹å¦‚

```js
import file from '../path/to/file';
```

é‚£ä¹ˆ webpack å°±ä¼šæŒ‰ç…§ extensions é…ç½®çš„æ•°ç»„ä»å·¦åˆ°å³çš„é¡ºåºå»å°è¯•è§£ææ¨¡å—

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

1. é«˜é¢‘æ–‡ä»¶åç¼€åæ”¾å‰é¢ï¼›
2. æ‰‹åŠ¨é…ç½®åï¼Œé»˜è®¤é…ç½®ä¼šè¢«è¦†ç›–

å¦‚æœæƒ³ä¿ç•™é»˜è®¤é…ç½®ï¼Œå¯ä»¥ç”¨ `...` æ‰©å±•è¿ç®—ç¬¦ä»£è¡¨é»˜è®¤é…ç½®ï¼Œä¾‹å¦‚

```js
const config = {
  //...
  resolve: {
    extensions: ['.ts', '...'], 
  },
};
```

##### 1.2.3 modules

å‘Šè¯‰ webpack è§£ææ¨¡å—æ—¶åº”è¯¥æœç´¢çš„ç›®å½•ï¼Œå¸¸è§é…ç½®å¦‚ä¸‹

```js
const path = require('path');

// è·¯å¾„å¤„ç†æ–¹æ³•
function resolve(dir){
  return path.join(__dirname, dir);
}

const config = {
  //...
  resolve: {
     modules: [resolve('src'), 'node_modules'],
  },
};
```

å‘Šè¯‰ webpack ä¼˜å…ˆ src ç›®å½•ä¸‹æŸ¥æ‰¾éœ€è¦è§£æçš„æ–‡ä»¶ï¼Œä¼šå¤§å¤§èŠ‚çœæŸ¥æ‰¾æ—¶é—´

##### 1.2.4 resolveLoader

resolveLoader ä¸ä¸Šé¢çš„ resolve å¯¹è±¡çš„å±æ€§é›†åˆç›¸åŒï¼Œ ä½†ä»…ç”¨äºè§£æ webpack çš„ [loader](https://link.juejin.cn?target=https%3A%2F%2Fwebpack.docschina.org%2Fconcepts%2Floaders) åŒ…ã€‚

**ä¸€èˆ¬æƒ…å†µä¸‹ä¿æŒé»˜è®¤é…ç½®å°±å¯ä»¥äº†ï¼Œä½†å¦‚æœä½ æœ‰è‡ªå®šä¹‰çš„ Loader å°±éœ€è¦é…ç½®ä¸€ä¸‹**ï¼Œä¸é…å¯èƒ½ä¼šå› ä¸ºæ‰¾ä¸åˆ° loader æŠ¥é”™

- ä¾‹å¦‚ï¼šæˆ‘ä»¬åœ¨ loader æ–‡ä»¶å¤¹ä¸‹é¢ï¼Œæ”¾ç€æˆ‘ä»¬è‡ªå·±å†™çš„ loader

æˆ‘ä»¬å°±å¯ä»¥æ€ä¹ˆé…ç½®

```js
const path = require('path');

// è·¯å¾„å¤„ç†æ–¹æ³•
function resolve(dir){
  return path.join(__dirname, dir);
}

const config = {
  //...
  resolveLoader: {
    modules: ['node_modules',resolve('loader')]
  },
};
```

#### 1.3 externals

`externals` é…ç½®é€‰é¡¹æä¾›äº†ã€Œ**ä»è¾“å‡ºçš„ bundle ä¸­æ’é™¤ä¾èµ–**ã€çš„æ–¹æ³•ã€‚æ­¤åŠŸèƒ½é€šå¸¸å¯¹ **library å¼€å‘äººå‘˜**æ¥è¯´æ˜¯æœ€æœ‰ç”¨çš„ï¼Œç„¶è€Œä¹Ÿä¼šæœ‰å„ç§å„æ ·çš„åº”ç”¨ç¨‹åºç”¨åˆ°å®ƒã€‚

ä¾‹å¦‚ï¼Œä» CDN å¼•å…¥ jQueryï¼Œè€Œä¸æ˜¯æŠŠå®ƒæ‰“åŒ…ï¼š

1. å¼•å…¥é“¾æ¥

```html
<script
  src="https://code.jquery.com/jquery-3.1.0.js"
  integrity="sha256-slogkvB1K3VOkzAI8QITxV3VzpOnkeNVsKvtkYLMjfk="
  crossorigin="anonymous"
></script>
```

1. é…ç½® externals

```js
const config = {
  //...
  externals: {
    jquery: 'jQuery',
  },
};
```

1. ä½¿ç”¨ jQuery

```js
import $ from 'jquery';

$('.my-element').animate(/* ... */);
```

æˆ‘ä»¬å¯ä»¥ç”¨è¿™æ ·çš„æ–¹æ³•æ¥å‰¥ç¦»ä¸éœ€è¦æ”¹åŠ¨çš„ä¸€äº›ä¾èµ–ï¼Œå¤§å¤§èŠ‚çœæ‰“åŒ…æ„å»ºçš„æ—¶é—´ã€‚

#### 1.3 ç¼©å°èŒƒå›´

åœ¨é…ç½® loader çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ›´ç²¾ç¡®çš„å»æŒ‡å®š loader çš„ä½œç”¨ç›®å½•æˆ–è€…éœ€è¦æ’é™¤çš„ç›®å½•ï¼Œé€šè¿‡ä½¿ç”¨ `include` å’Œ `exclude` ä¸¤ä¸ªé…ç½®é¡¹ï¼Œå¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œå¸¸è§çš„ä¾‹å¦‚ï¼š

- **`include`**ï¼šç¬¦åˆæ¡ä»¶çš„æ¨¡å—è¿›è¡Œè§£æ
- **`exclude`**ï¼šæ’é™¤ç¬¦åˆæ¡ä»¶çš„æ¨¡å—ï¼Œä¸è§£æ
- **`exclude`** ä¼˜å…ˆçº§æ›´é«˜

ä¾‹å¦‚åœ¨é…ç½® babel çš„æ—¶å€™

```js
const path = require('path');

// è·¯å¾„å¤„ç†æ–¹æ³•
function resolve(dir){
  return path.join(__dirname, dir);
}

const config = {
  //...
  module: { 
    noParse: /jquery|lodash/,
    rules: [
      {
        test: /\.js$/i,
        include: resolve('src'),
        exclude: /node_modules/,
        use: [
          'babel-loader',
        ]
      },
      // ...
    ]
  }
};
```

#### 1.3 noParse

- ä¸éœ€è¦è§£æä¾èµ–çš„ç¬¬ä¸‰æ–¹å¤§å‹ç±»åº“ç­‰ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªå­—æ®µè¿›è¡Œé…ç½®ï¼Œä»¥æé«˜æ„å»ºé€Ÿåº¦
- ä½¿ç”¨ noParse è¿›è¡Œå¿½ç•¥çš„æ¨¡å—æ–‡ä»¶ä¸­ä¸ä¼šè§£æ `import`ã€`require` ç­‰è¯­æ³•

```js
const config = {
  //...
  module: { 
    noParse: /jquery|lodash/,
    rules:[...]
  }

};
```

#### 1.4 IgnorePlugin

é˜²æ­¢åœ¨ `import` æˆ– `require` è°ƒç”¨æ—¶ï¼Œç”Ÿæˆä»¥ä¸‹æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„æ¨¡å—ï¼š

- `requestRegExp` åŒ¹é…(test)èµ„æºè¯·æ±‚è·¯å¾„çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚
- `contextRegExp` åŒ¹é…(test)èµ„æºä¸Šä¸‹æ–‡ï¼ˆç›®å½•ï¼‰çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚

```js
new webpack.IgnorePlugin({ resourceRegExp, contextRegExp });
```

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†æ­¤æ’ä»¶çš„å‡ ç§ç”¨æ³•ã€‚

1. å®‰è£… moment æ’ä»¶ï¼ˆæ—¶é—´å¤„ç†åº“ï¼‰

```js
$ npm i -S moment
```

1. é…ç½® IgnorePlugin

```js
// å¼•å…¥ webpack
const webpack = require('webpack')

const config = {
  ...
  plugins:[ // é…ç½®æ’ä»¶
    ...
    new webpack.IgnorePlugin({
      resourceRegExp: /^\.\/locale$/,
      contextRegExp: /moment$/,
    }),
  ]  
};
```

ç›®çš„æ˜¯å°†æ’ä»¶ä¸­çš„éä¸­æ–‡è¯­éŸ³æ’é™¤æ‰ï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§èŠ‚çœæ‰“åŒ…çš„ä½“ç§¯äº†

#### 1.5 å¤šè¿›ç¨‹é…ç½®

> **æ³¨æ„**ï¼šå®é™…ä¸Šåœ¨å°å‹é¡¹ç›®ä¸­ï¼Œå¼€å¯å¤šè¿›ç¨‹æ‰“åŒ…åè€Œä¼šå¢åŠ æ—¶é—´æˆæœ¬ï¼Œå› ä¸ºå¯åŠ¨è¿›ç¨‹å’Œè¿›ç¨‹é—´é€šä¿¡éƒ½ä¼šæœ‰ä¸€å®šå¼€é”€ã€‚

##### 1.5.1 thread-loader

é…ç½®åœ¨ [thread-loader](https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.docschina.org%2Floaders%2Fthread-loader%2F%23root) ä¹‹åçš„ loader éƒ½ä¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„ worker æ± ï¼ˆworker poolï¼‰ä¸­è¿è¡Œ

1. å®‰è£…

```bash
$ npm i -D  thread-loader
```

1. é…ç½®

```js
const path = require('path');

// è·¯å¾„å¤„ç†æ–¹æ³•
function resolve(dir){
  return path.join(__dirname, dir);
}

const config = {
  //...
  module: { 
    noParse: /jquery|lodash/,
    rules: [
      {
        test: /\.js$/i,
        include: resolve('src'),
        exclude: /node_modules/,
        use: [
          {
            loader: 'thread-loader', // å¼€å¯å¤šè¿›ç¨‹æ‰“åŒ…
            options: {
              worker: 3,
            }
          },
          'babel-loader',
        ]
      },
      // ...
    ]
  }
};
```

##### 1.5.2 happypack âŒ

åŒæ ·ä¸ºå¼€å¯å¤šè¿›ç¨‹æ‰“åŒ…çš„å·¥å…·ï¼Œwebpack5 å·²å¼ƒç”¨ã€‚

#### 1.6 åˆ©ç”¨ç¼“å­˜

åˆ©ç”¨ç¼“å­˜å¯ä»¥å¤§å¹…æå‡é‡å¤æ„å»ºçš„é€Ÿåº¦

##### 1.6.1 babel-loader å¼€å¯ç¼“å­˜

- babel åœ¨è½¬è¯‘ js è¿‡ç¨‹ä¸­æ—¶é—´å¼€é”€æ¯”ä»·å¤§ï¼Œå°† babel-loader çš„æ‰§è¡Œç»“æœç¼“å­˜èµ·æ¥ï¼Œé‡æ–°æ‰“åŒ…çš„æ—¶å€™ï¼Œç›´æ¥è¯»å–ç¼“å­˜
- ç¼“å­˜ä½ç½®ï¼š `node_modules/.cache/babel-loader`

å…·ä½“é…ç½®å¦‚ä¸‹ï¼š

```js
const config = {
 module: { 
    noParse: /jquery|lodash/,
    rules: [
      {
        test: /\.js$/i,
        include: resolve('src'),
        exclude: /node_modules/,
        use: [
          // ...
          {
            loader: 'babel-loader',
            options: {
              cacheDirectory: true // å¯ç”¨ç¼“å­˜
            }
          },
        ]
      },
      // ...
    ]
  }
}
```

é‚£å…¶ä»–çš„ loader å¦‚ä½•å°†ç»“æœç¼“å­˜å‘¢ï¼Ÿ

[cache-loader](https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fcache-loader) å°±å¯ä»¥å¸®æˆ‘ä»¬å®Œæˆè¿™ä»¶äº‹æƒ…

##### 1.6.2 cache-loader

- ç¼“å­˜ä¸€äº›æ€§èƒ½å¼€é”€æ¯”è¾ƒå¤§çš„ loader çš„å¤„ç†ç»“æœ
- ç¼“å­˜ä½ç½®ï¼š`node_modules/.cache/cache-loader`

1. å®‰è£…

```bash
$ npm i -D cache-loader
```

1. é…ç½® cache-loader

```js
const config = {
 module: { 
    // ...
    rules: [
      {
        test: /\.(s[ac]|c)ss$/i, //åŒ¹é…æ‰€æœ‰çš„ sass/scss/css æ–‡ä»¶
        use: [
          // 'style-loader',
          MiniCssExtractPlugin.loader,
          'cache-loader', // è·å–å‰é¢ loader è½¬æ¢çš„ç»“æœ
          'css-loader',
          'postcss-loader',
          'sass-loader', 
        ]
      }, 
      // ...
    ]
  }
}
```

##### 1.6.3 hard-source-webpack-plugin

- [hard-source-webpack-plugin](https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmzgoddard%2Fhard-source-webpack-plugin) ä¸ºæ¨¡å—æä¾›äº†ä¸­é—´ç¼“å­˜ï¼Œé‡å¤æ„å»ºæ—¶é—´å¤§çº¦å¯ä»¥å‡å°‘ 80%ï¼Œä½†æ˜¯åœ¨ **webpack5 ä¸­å·²ç»å†…ç½®äº†æ¨¡å—ç¼“å­˜ï¼Œä¸éœ€è¦å†ä½¿ç”¨æ­¤æ’ä»¶**

##### 1.6.4 dll âŒ

åœ¨ webpack5.x ä¸­å·²ç»ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡Œæ¨¡å—ç¼“å­˜ï¼Œå› ä¸ºå…¶å·²ç»å†…ç½®äº†æ›´å¥½ä½“éªŒçš„ cache æ–¹æ³•

##### 1.6.5 cache æŒä¹…åŒ–ç¼“å­˜

é€šè¿‡é…ç½® [cache](https://link.juejin.cn?target=https%3A%2F%2Fwebpack.docschina.org%2Fconfiguration%2Fcache%2F%23root) ç¼“å­˜ç”Ÿæˆçš„ webpack æ¨¡å—å’Œ chunkï¼Œæ¥æ”¹å–„æ„å»ºé€Ÿåº¦ã€‚

```js
const config = {
  cache: {
    type: 'filesystem',
  },
};
```

### 2. ä¼˜åŒ–æ„å»ºç»“æœ

#### 2.1 æ„å»ºç»“æœåˆ†æ

å€ŸåŠ©æ’ä»¶ [webpack-bundle-analyzer](https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fwebpack-bundle-analyzer) æˆ‘ä»¬å¯ä»¥ç›´è§‚çš„çœ‹åˆ°æ‰“åŒ…ç»“æœä¸­ï¼Œæ–‡ä»¶çš„ä½“ç§¯å¤§å°ã€å„æ¨¡å—ä¾èµ–å…³ç³»ã€æ–‡ä»¶æ˜¯å¤Ÿé‡å¤ç­‰é—®é¢˜ï¼Œæå¤§çš„æ–¹ä¾¿æˆ‘ä»¬åœ¨è¿›è¡Œé¡¹ç›®ä¼˜åŒ–çš„æ—¶å€™ï¼Œè¿›è¡Œé—®é¢˜è¯Šæ–­ã€‚

1. å®‰è£…

```bash
$ npm i -D webpack-bundle-analyzer
```

1. é…ç½®æ’ä»¶

```js
// å¼•å…¥æ’ä»¶
const BundleAnalyzerPlugin = require('webpack-bundle-analyzer').BundleAnalyzerPlugin


const config = {
  // ...
  plugins:[ 
    // ...
    // é…ç½®æ’ä»¶ 
    new BundleAnalyzerPlugin({
      // analyzerMode: 'disabled',  // ä¸å¯åŠ¨å±•ç¤ºæ‰“åŒ…æŠ¥å‘Šçš„httpæœåŠ¡å™¨
      // generateStatsFile: true, // æ˜¯å¦ç”Ÿæˆstats.jsonæ–‡ä»¶
    })
  ],
};
```

1. ä¿®æ”¹å¯åŠ¨å‘½ä»¤

```json
 "scripts": {
    // ...
    "analyzer": "cross-env NODE_ENV=prod webpack --progress --mode production"
  },
```

1. æ‰§è¡Œç¼–è¯‘å‘½ä»¤ `npm run analyzer`

æ‰“åŒ…ç»“æŸåï¼Œä¼šè‡ªè¡Œå¯åŠ¨åœ°å€ä¸º `http://127.0.0.1:8888` çš„ web æœåŠ¡ï¼Œè®¿é—®åœ°å€å°±å¯ä»¥çœ‹åˆ°

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee392f0838bd43e5aeeb405c76f2fbc7~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

å¦‚æœï¼Œæˆ‘ä»¬åªæƒ³ä¿ç•™æ•°æ®ä¸æƒ³å¯åŠ¨ web æœåŠ¡ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸Šä¸¤ä¸ªé…ç½®

```js
new BundleAnalyzerPlugin({
   analyzerMode: 'disabled',  // ä¸å¯åŠ¨å±•ç¤ºæ‰“åŒ…æŠ¥å‘Šçš„httpæœåŠ¡å™¨
   generateStatsFile: true, // æ˜¯å¦ç”Ÿæˆstats.jsonæ–‡ä»¶
})
```

è¿™æ ·å†æ¬¡æ‰§è¡Œæ‰“åŒ…çš„æ—¶å€™å°±åªä¼šäº§ç”Ÿ state.json çš„æ–‡ä»¶äº†

#### 2.2 å‹ç¼© CSS

1. å®‰è£… [`optimize-css-assets-webpack-plugin`](https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Foptimize-css-assets-webpack-plugin)

```bash
$ npm install -D optimize-css-assets-webpack-plugin 
```

1. ä¿®æ”¹ `webapck.config.js` é…ç½®

```js
// ...
// å‹ç¼©css
const OptimizeCssAssetsPlugin = require('optimize-css-assets-webpack-plugin')
// ...

const config = {
  // ...
  optimization: {
    minimize: true,
    minimizer: [
      // æ·»åŠ  css å‹ç¼©é…ç½®
      new OptimizeCssAssetsPlugin({}),
    ]
  },
 // ...
}

// ...
```

1. æŸ¥çœ‹æ‰“åŒ…ç»“æœ

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2b3174e204994b2e9c845f5bbc144577~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

#### 2.3 å‹ç¼© JS

> åœ¨ç”Ÿæˆç¯å¢ƒä¸‹æ‰“åŒ…é»˜è®¤ä¼šå¼€å¯ js å‹ç¼©ï¼Œä½†æ˜¯å½“æˆ‘ä»¬æ‰‹åŠ¨é…ç½® `optimization` é€‰é¡¹ä¹‹åï¼Œå°±ä¸å†é»˜è®¤å¯¹ js è¿›è¡Œå‹ç¼©ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»é…ç½®ã€‚

å› ä¸º webpack5 å†…ç½®äº†[terser-webpack-plugin](https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fterser-webpack-plugin) æ’ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€é‡å¤å®‰è£…ï¼Œç›´æ¥å¼•ç”¨å°±å¯ä»¥äº†ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹

```js
const TerserPlugin = require('terser-webpack-plugin');

const config = {
  // ...
  optimization: {
    minimize: true, // å¼€å¯æœ€å°åŒ–
    minimizer: [
      // ...
      new TerserPlugin({})
    ]
  },
  // ...
}
```

#### 2.4 æ¸…é™¤æ— ç”¨çš„ CSS

[purgecss-webpack-plugin](https://link.juejin.cn?target=https%3A%2F%2Fwww.purgecss.cn%2Fplugins%2Fwebpack.html%23%E7%94%A8%E6%B3%95) ä¼šå•ç‹¬æå– CSS å¹¶æ¸…é™¤ç”¨ä¸åˆ°çš„ CSS

1. å®‰è£…æ’ä»¶

```bash
$ npm i -D purgecss-webpack-plugin
```

1. æ·»åŠ é…ç½®

```js
// ...
const PurgecssWebpackPlugin = require('purgecss-webpack-plugin')
const glob = require('glob'); // æ–‡ä»¶åŒ¹é…æ¨¡å¼
// ...

function resolve(dir){
  return path.join(__dirname, dir);
}

const PATHS = {
  src: resolve('src')
}

const config = {
  plugins:[ // é…ç½®æ’ä»¶
    // ...
    new PurgecssPlugin({
      paths: glob.sync(`${PATHS.src}/**/*`, {nodir: true})
    }),
  ]
}
```

1. index.html æ–°å¢èŠ‚ç‚¹

```html
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ITEM</title>
</head>
<body>
  <p></p>
  <!-- ä½¿ç”¨å­—ä½“å›¾æ ‡æ–‡ä»¶ -->
  <i class="iconfont icon-member"></i>
  <div id="imgBox"></div>
  
   <!-- æ–°å¢ divï¼Œè®¾ç½® class ä¸º used -->
  <div class="used"></div>
</body>
</html>
```

1. åœ¨ sass.scss ä¸­æ·»åŠ æ ·å¼

```css
.used {
  width: 200px;
  height: 200px;
  background: #ccc;
}

.unused {
  background: chocolate;
}
```

1. æ‰§è¡Œä¸€ä¸‹æ‰“åŒ…

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ca0ac6b477146ad82d6b1332ae626a6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åªæœ‰ `.used` è¢«ä¿å­˜ä¸‹æ¥

å¦‚ä½•è¯æ˜æ˜¯è¿™ä¸ªæ’ä»¶çš„ä½œç”¨å‘¢ï¼Ÿæ³¨é‡Šæ‰å†æ‰“åŒ…å°±å¯ä»¥çœ‹åˆ°ï¼Œ`.unused` ä¹Ÿä¼šè¢«æ‰“åŒ…è¿›å»ï¼Œç”±æ­¤å¯è¯...

#### 2.5 Tree-shaking

Tree-shaking ä½œç”¨æ˜¯å‰”é™¤æ²¡æœ‰ä½¿ç”¨çš„ä»£ç ï¼Œä»¥é™ä½åŒ…çš„ä½“ç§¯

- webpack é»˜è®¤æ”¯æŒï¼Œéœ€è¦åœ¨ .bablerc é‡Œé¢è®¾ç½® `modelï¼šfalse`ï¼Œå³å¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹é»˜è®¤å¼€å¯

äº†è§£æ›´å¤š Tree-shaking çŸ¥è¯†ï¼Œæ¨èé˜…è¯» ğŸ‘‰ğŸ» [ä»è¿‡å»åˆ°ç°åœ¨ï¼ŒèŠèŠ Tree-shaking](https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FTNXO2ifPymaTxIqzBAmkSQ)

```js
module.exports = {
  presets: [
    [
      "@babel/preset-env",
      {
        module: false,
        useBuiltIns: "entry",
        corejs: "3.9.1",
        targets: {
          chrome: "58",
          ie: "11",
        },
      },
    ],
  ],
  plugins: [    
    ["@babel/plugin-proposal-decorators", { legacy: true }],
    ["@babel/plugin-proposal-class-properties", { loose: true }],
  ]
};
```

#### 2.6 Scope Hoisting

Scope Hoisting å³ä½œç”¨åŸŸæå‡ï¼ŒåŸç†æ˜¯å°†å¤šä¸ªæ¨¡å—æ”¾åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸä¸‹ï¼Œå¹¶é‡å‘½åé˜²æ­¢å‘½åå†²çªï¼Œ**é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘å‡½æ•°å£°æ˜å’Œå†…å­˜å¼€é”€**ã€‚

- webpack é»˜è®¤æ”¯æŒï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹é»˜è®¤å¼€å¯
- åªæ”¯æŒ es6 ä»£ç 

### 3. ä¼˜åŒ–è¿è¡Œæ—¶ä½“éªŒ

è¿è¡Œæ—¶ä¼˜åŒ–çš„æ ¸å¿ƒå°±æ˜¯æå‡é¦–å±çš„åŠ è½½é€Ÿåº¦ï¼Œä¸»è¦çš„æ–¹å¼å°±æ˜¯

- é™ä½é¦–å±åŠ è½½æ–‡ä»¶ä½“ç§¯ï¼Œé¦–å±ä¸éœ€è¦çš„æ–‡ä»¶è¿›è¡Œé¢„åŠ è½½æˆ–è€…æŒ‰éœ€åŠ è½½

#### 3.1 å…¥å£ç‚¹åˆ†å‰²

é…ç½®å¤šä¸ªæ‰“åŒ…å…¥å£ï¼Œå¤šé¡µæ‰“åŒ…ï¼Œè¿™é‡Œä¸è¿‡å¤šä»‹ç»

#### 3.2 splitChunks åˆ†åŒ…é…ç½®

optimization.splitChunks æ˜¯åŸºäº [SplitChunksPlugin](https://link.juejin.cn?target=https%3A%2F%2Fwebpack.docschina.org%2Fplugins%2Fsplit-chunks-plugin%2F) æ’ä»¶å®ç°çš„

é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒåªä¼šå½±å“åˆ°æŒ‰éœ€åŠ è½½çš„ chunksï¼Œå› ä¸ºä¿®æ”¹ initial chunks ä¼šå½±å“åˆ°é¡¹ç›®çš„ HTML æ–‡ä»¶ä¸­çš„è„šæœ¬æ ‡ç­¾ã€‚

webpack å°†æ ¹æ®ä»¥ä¸‹æ¡ä»¶è‡ªåŠ¨æ‹†åˆ† chunksï¼š

- æ–°çš„ chunk å¯ä»¥è¢«å…±äº«ï¼Œæˆ–è€…æ¨¡å—æ¥è‡ªäº `node_modules` æ–‡ä»¶å¤¹
- æ–°çš„ chunk ä½“ç§¯å¤§äº 20kbï¼ˆåœ¨è¿›è¡Œ min+gz ä¹‹å‰çš„ä½“ç§¯ï¼‰
- å½“æŒ‰éœ€åŠ è½½ chunks æ—¶ï¼Œå¹¶è¡Œè¯·æ±‚çš„æœ€å¤§æ•°é‡å°äºæˆ–ç­‰äº 30
- å½“åŠ è½½åˆå§‹åŒ–é¡µé¢æ—¶ï¼Œå¹¶å‘è¯·æ±‚çš„æœ€å¤§æ•°é‡å°äºæˆ–ç­‰äº 30

1. é»˜è®¤é…ç½®ä»‹ç»

```js
module.exports = {
  //...
  optimization: {
    splitChunks: {
      chunks: 'async', // æœ‰æ•ˆå€¼ä¸º `all`ï¼Œ`async` å’Œ `initial`
      minSize: 20000, // ç”Ÿæˆ chunk çš„æœ€å°ä½“ç§¯ï¼ˆâ‰ˆ 20kb)
      minRemainingSize: 0, // ç¡®ä¿æ‹†åˆ†åå‰©ä½™çš„æœ€å° chunk ä½“ç§¯è¶…è¿‡é™åˆ¶æ¥é¿å…å¤§å°ä¸ºé›¶çš„æ¨¡å—
      minChunks: 1, // æ‹†åˆ†å‰å¿…é¡»å…±äº«æ¨¡å—çš„æœ€å° chunks æ•°ã€‚
      maxAsyncRequests: 30, // æœ€å¤§çš„æŒ‰éœ€(å¼‚æ­¥)åŠ è½½æ¬¡æ•°
      maxInitialRequests: 30, // æ‰“åŒ…åçš„å…¥å£æ–‡ä»¶åŠ è½½æ—¶ï¼Œè¿˜èƒ½åŒæ—¶åŠ è½½jsæ–‡ä»¶çš„æ•°é‡ï¼ˆåŒ…æ‹¬å…¥å£æ–‡ä»¶ï¼‰
      enforceSizeThreshold: 50000,
      cacheGroups: { // é…ç½®æå–æ¨¡å—çš„æ–¹æ¡ˆ
        defaultVendors: {
          test: /[\/]node_modules[\/]/,
          priority: -10,
          reuseExistingChunk: true,
        },
        default: {
          minChunks: 2,
          priority: -20,
          reuseExistingChunk: true,
        },
      },
    },
  },
};
```

1. é¡¹ç›®ä¸­çš„ä½¿ç”¨

```js
const config = {
  //...
  optimization: {
    splitChunks: {
      cacheGroups: { // é…ç½®æå–æ¨¡å—çš„æ–¹æ¡ˆ
        default: false,
        styles: {
            name: 'styles',
            test: /\.(s?css|less|sass)$/,
            chunks: 'all',
            enforce: true,
            priority: 10,
          },
          common: {
            name: 'chunk-common',
            chunks: 'all',
            minChunks: 2,
            maxInitialRequests: 5,
            minSize: 0,
            priority: 1,
            enforce: true,
            reuseExistingChunk: true,
          },
          vendors: {
            name: 'chunk-vendors',
            test: /[\\/]node_modules[\\/]/,
            chunks: 'all',
            priority: 2,
            enforce: true,
            reuseExistingChunk: true,
          },
         // ... æ ¹æ®ä¸åŒé¡¹ç›®å†ç»†åŒ–æ‹†åˆ†å†…å®¹
      },
    },
  },
}
```

#### 3.3 ä»£ç æ‡’åŠ è½½

é’ˆå¯¹é¦–å±åŠ è½½ä¸å¤ªéœ€è¦çš„ä¸€äº›èµ„æºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‡’åŠ è½½çš„æ–¹å¼å»å®ç°ï¼Œä¸‹é¢çœ‹ä¸€ä¸ªå°ğŸŒ°

- éœ€æ±‚ï¼šç‚¹å‡»å›¾ç‰‡ç»™å›¾ç‰‡åŠ ä¸€ä¸ªæè¿°

**1. æ–°å»ºå›¾ç‰‡æè¿°ä¿¡æ¯**

**desc.js**

```js
const ele = document.createElement('div')
ele.innerHTML = 'æˆ‘æ˜¯å›¾ç‰‡æè¿°'
module.exports = ele
```

**2. ç‚¹å‡»å›¾ç‰‡å¼•å…¥æè¿°**

**index.js**

```js
import './main.css';
import './sass.scss'
import logo from '../public/avatar.png'

import '@/fonts/iconfont.css'

const a = 'Hello ITEM'
console.log(a)

const img = new Image()
img.src = logo

document.getElementById('imgBox').appendChild(img)

// æŒ‰éœ€åŠ è½½
img.addEventListener('click', () => {
  import('./desc').then(({ default: element }) => {
    console.log(element)
    document.body.appendChild(element)
  })
})
```

**3. æŸ¥çœ‹æ•ˆæœ**

- ç‚¹å‡»å‰

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6cdeeabe18da4e5f93edc40e429b30c8~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c9ac178ffa340b8824e0dc18f8a6a1a~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

- ç‚¹å‡»å

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d1f0d664c3e34deda3e8270ce20f6116~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2f2be3f57164f06863b0283ea396e12~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

#### 3.4 prefetch ä¸ preload

ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨å¼‚æ­¥åŠ è½½çš„æ–¹å¼å¼•å…¥å›¾ç‰‡çš„æè¿°ï¼Œä½†æ˜¯å¦‚æœéœ€è¦å¼‚æ­¥åŠ è½½çš„æ–‡ä»¶æ¯”è¾ƒå¤§æ—¶ï¼Œåœ¨ç‚¹å‡»çš„æ—¶å€™å»åŠ è½½ä¹Ÿä¼šå½±å“åˆ°æˆ‘ä»¬çš„ä½“éªŒï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ prefetch æ¥è¿›è¡Œé¢„æ‹‰å–

##### 3.4.1 prefetch

> - **prefetch** (é¢„è·å–)ï¼šæµè§ˆå™¨ç©ºé—²çš„æ—¶å€™è¿›è¡Œèµ„æºçš„æ‹‰å–

æ”¹é€ ä¸€ä¸‹ä¸Šé¢çš„ä»£ç 

```js
// æŒ‰éœ€åŠ è½½
img.addEventListener('click', () => {
  import( /* webpackPrefetch: true */ './desc').then(({ default: element }) => {
    console.log(element)
    document.body.appendChild(element)
  })
})
```

##### 3.4.2 preload

> - **preload** (é¢„åŠ è½½)ï¼šæå‰åŠ è½½åé¢ä¼šç”¨åˆ°çš„å…³é”®èµ„æº
> - âš ï¸ å› ä¸ºä¼šæå‰æ‹‰å–èµ„æºï¼Œå¦‚æœä¸æ˜¯ç‰¹æ®Šéœ€è¦ï¼Œè°¨æ…ä½¿ç”¨

å®˜ç½‘ç¤ºä¾‹ï¼š

```js
import(/* webpackPreload: true */ 'ChartingLibrary');
```

